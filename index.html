<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mega Tab Photo Editor</title>
    <style>
        :root { --bg: #000; --panel: #1e1e1e; --accent: #00d1b2; --text: #fff; --tab-h: 70px; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #111; height: 50px; }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        .viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; background: #000; padding: 10px; }
        canvas { max-width: 100%; max-height: 100%; box-shadow: 0 0 30px rgba(0,0,0,0.8); transition: transform 0.2s; }

        /* ãƒœãƒˆãƒ ãƒ‘ãƒãƒ«æ§‹æˆ */
        .bottom-panel { background: var(--panel); border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        
        /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éƒ¨åˆ† */
        .controls-scroll { display: none; overflow-x: auto; white-space: nowrap; padding: 20px 15px; gap: 12px; height: 100px; align-items: center; }
        .controls-scroll.active { display: flex; }
        
        .btn-item { min-width: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #2d2d2d; padding: 12px; border-radius: 12px; border: 1px solid #444; }
        .btn-item label { font-size: 11px; margin-bottom: 8px; color: #ccc; font-weight: bold; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ï¼ˆã“ã“ã‚’å¤§ããï¼ï¼‰ */
        .tabs { display: flex; height: var(--tab-h); background: #111; border-top: 1px solid #333; }
        .tab { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            font-weight: bold; 
            color: #666; 
            cursor: pointer;
            transition: 0.3s;
        }
        .tab i { font-size: 20px; margin-bottom: 4px; } /* ã‚¢ã‚¤ã‚³ãƒ³ç”¨ï¼ˆæ–‡å­—ã§ä»£ç”¨ï¼‰ */
        .tab.active { color: var(--accent); background: #1e1e1e; border-top: 3px solid var(--accent); }

        /* ãƒœã‚¿ãƒ³ãƒ»å…¥åŠ› */
        button { background: #444; color: white; border: none; padding: 10px 14px; border-radius: 8px; font-size: 12px; cursor: pointer; width: 100%; font-weight: bold; }
        button:active { background: var(--accent); color: #000; transform: scale(0.95); }
        .primary { background: var(--accent); color: #000; }
        input[type="range"] { width: 80px; accent-color: var(--accent); }
    </style>
</head>
<body>

<div class="toolbar">
    <button style="width:auto" onclick="document.getElementById('upload').click()">ğŸ“‚ é–‹ã</button>
    <div style="font-size: 14px; letter-spacing: 1px;">IMAGE EDITOR</div>
    <button class="primary" style="width:auto" onclick="downloadImage()">ğŸ’¾ ä¿å­˜</button>
    <input type="file" id="upload" hidden accept="image/*">
</div>

<div class="viewport">
    <canvas id="canvas"></canvas>
</div>

<div class="bottom-panel">
    <div id="tab0" class="controls-scroll active">
        <div class="btn-item"><label>æ˜ã‚‹ã•</label><input type="range" id="brightness" min="0" max="200" value="100" onchange="applyFilters()"></div>
        <div class="btn-item"><label>å½©åº¦</label><input type="range" id="saturate" min="0" max="200" value="100" onchange="applyFilters()"></div>
        <div class="btn-item"><label>å›è»¢</label><button onclick="rotate()">â†· 90Â°</button></div>
        <div class="btn-item"><label>å·¦å³åè»¢</label><button onclick="flip('h')">â‡„</button></div>
        <div class="btn-item"><label>ä¸Šä¸‹åè»¢</label><button onclick="flip('v')">â‡…</button></div>
        <div class="btn-item"><label>ãƒªã‚»ãƒƒãƒˆ</label><button onclick="resetAll()">âœ• æˆ»ã™</button></div>
    </div>

    <div id="tab1" class="controls-scroll">
        <div class="btn-item"><label>ãƒ¢ã‚¶ã‚¤ã‚¯</label><button onclick="pixelate()">é©ç”¨</button></div>
        <div class="btn-item"><label>2å€¤åŒ–</label><button onclick="threshold()">é©ç”¨</button></div>
        <div class="btn-item"><label>ã‚·ãƒ£ãƒ¼ãƒ—</label><button onclick="convolute([-1,-1,-1,-1,9,-1,-1,-1,-1])">é©ç”¨</button></div>
        <div class="btn-item"><label>è¼ªéƒ­</label><button onclick="convolute([0,1,0,1,-4,1,0,1,0])">æŠ½å‡º</button></div>
        <div class="btn-item"><label>ã‚¨ãƒ³ãƒœã‚¹</label><button onclick="convolute([-2,-1,0,-1,1,1,0,1,2])">é©ç”¨</button></div>
        <div class="btn-item"><label>å‘¨è¾ºæ¸›å…‰</label><button onclick="vignette()">é©ç”¨</button></div>
    </div>

    <div id="tab2" class="controls-scroll">
        <div class="btn-item"><label>ã‚»ãƒ”ã‚¢</label><button onclick="quickFilter('sepia(1)')">é©ç”¨</button></div>
        <div class="btn-item"><label>ãƒ¢ãƒã‚¯ãƒ­</label><button onclick="quickFilter('grayscale(1)')">é©ç”¨</button></div>
        <div class="btn-item"><label>æ—¥ä»˜å°</label><button onclick="addTimestamp()">åˆ»å°</button></div>
        <div class="btn-item"><label>ãƒ¬ãƒˆãƒ­</label><button onclick="quickFilter('sepia(0.6) contrast(1.1)')">é©ç”¨</button></div>
        <div class="btn-item"><label>ç™½æ </label><button onclick="addFrame()">è¿½åŠ </button></div>
        <div class="btn-item"><label>ã‚µã‚¤ãƒ³</label><button onclick="addWatermark()">æŒ¿å…¥</button></div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(0)">
            <span>èª¿æ•´</span>
        </div>
        <div class="tab" onclick="switchTab(1)">
            <span>åŠ å·¥</span>
        </div>
        <div class="tab" onclick="switchTab(2)">
            <span>ã‚¢ãƒ¼ãƒˆ</span>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();
    let offCanvas = document.createElement('canvas');
    let octx = offCanvas.getContext('2d');

    function switchTab(idx) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.controls-scroll').forEach((c, i) => c.classList.toggle('active', i === idx));
    }

    document.getElementById('upload').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => {
            img.onload = () => {
                canvas.width = offCanvas.width = img.width;
                canvas.height = offCanvas.height = img.height;
                octx.drawImage(img, 0, 0);
                commit();
            };
            img.src = f.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function commit() {
        ctx.filter = 'none';
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(offCanvas, 0, 0);
    }

    function updateOffCanvas() {
        offCanvas.width = canvas.width;
        offCanvas.height = canvas.height;
        octx.drawImage(canvas, 0, 0);
        commit();
    }

    function applyFilters() {
        const b = document.getElementById('brightness').value;
        const s = document.getElementById('saturate').value;
        ctx.filter = `brightness(${b}%) saturate(${s}%)`;
        ctx.drawImage(offCanvas, 0, 0);
    }

    function rotate() {
        let w = canvas.width, h = canvas.height;
        canvas.width = h; canvas.height = w;
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(90 * Math.PI / 180);
        ctx.drawImage(offCanvas, -w/2, -h/2);
        updateOffCanvas();
    }

    function flip(dir) {
        ctx.save();
        if(dir==='h') { ctx.scale(-1, 1); ctx.drawImage(offCanvas, -canvas.width, 0); }
        else { ctx.scale(1, -1); ctx.drawImage(offCanvas, 0, -canvas.height); }
        ctx.restore();
        updateOffCanvas();
    }

    function pixelate() {
        const size = 12;
        for(let y=0; y<canvas.height; y+=size) {
            for(let x=0; x<canvas.width; x+=size) {
                const p = ctx.getImageData(x, y, 1, 1).data;
                ctx.fillStyle = `rgb(${p[0]},${p[1]},${p[2]})`;
                ctx.fillRect(x, y, size, size);
            }
        }
        updateOffCanvas();
    }

    function threshold() {
        const d = ctx.getImageData(0,0,canvas.width,canvas.height);
        for(let i=0; i<d.data.length; i+=4) {
            const v = (d.data[i]+d.data[i+1]+d.data[i+2])/3 > 128 ? 255 : 0;
            d.data[i]=d.data[i+1]=d.data[i+2]=v;
        }
        ctx.putImageData(d,0,0);
        updateOffCanvas();
    }

    function convolute(weights) {
        const side = Math.round(Math.sqrt(weights.length));
        const halfSide = Math.floor(side/2);
        const src = ctx.getImageData(0,0,canvas.width, canvas.height);
        const sw = src.width, sh = src.height;
        const output = ctx.createImageData(sw, sh);
        for (let y=0; y<sh; y++) {
            for (let x=0; x<sw; x++) {
                let r=0, g=0, b=0;
                for (let cy=0; cy<side; cy++) {
                    for (let cx=0; cx<side; cx++) {
                        const scy = y + cy - halfSide;
                        const scx = x + cx - halfSide;
                        if (scy >= 0 && scy < sh && scx >= 0 && scx < sw) {
                            const srcOff = (scy*sw+scx)*4;
                            const wt = weights[cy*side+cx];
                            r += src.data[srcOff] * wt;
                            g += src.data[srcOff+1] * wt;
                            b += src.data[srcOff+2] * wt;
                        }
                    }
                }
                const dstOff = (y*sw+x)*4;
                output.data[dstOff]=r; output.data[dstOff+1]=g; output.data[dstOff+2]=b; output.data[dstOff+3]=255;
            }
        }
        ctx.putImageData(output, 0, 0);
        updateOffCanvas();
    }

    function quickFilter(f) {
        ctx.filter = f;
        ctx.drawImage(offCanvas, 0, 0);
        updateOffCanvas();
    }

    function addTimestamp() {
        ctx.font = "bold 35px sans-serif";
        ctx.fillStyle = "rgba(255,140,0,0.8)";
        ctx.fillText(new Date().toLocaleDateString(), canvas.width-220, canvas.height-40);
        updateOffCanvas();
    }

    function addFrame() {
        ctx.strokeStyle = "white"; ctx.lineWidth = 50; ctx.strokeRect(0,0,canvas.width,canvas.height);
        updateOffCanvas();
    }

    function vignette() {
        const grd = ctx.createRadialGradient(canvas.width/2, canvas.height/2, canvas.width*0.2, canvas.width/2, canvas.height/2, canvas.width*0.9);
        grd.addColorStop(0, "transparent");
        grd.addColorStop(1, "rgba(0,0,0,0.8)");
        ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width, canvas.height);
        updateOffCanvas();
    }

    function addWatermark() {
        ctx.font = "italic 25px serif"; ctx.fillStyle = "rgba(255,255,255,0.4)";
        ctx.fillText("Â© Creative Studio", 30, canvas.height-30);
        updateOffCanvas();
    }

    function resetAll() {
        offCanvas.width = img.width; offCanvas.height = img.height;
        octx.drawImage(img, 0, 0);
        document.getElementById('brightness').value = 100;
        document.getElementById('saturate').value = 100;
        commit();
    }

    function downloadImage() {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = 'edited_photo.png';
        a.click();
    }
</script>

</body>
</html>

